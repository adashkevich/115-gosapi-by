<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
          integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="../stylesheets/bootstrap-select-1.13.2/bootstrap-select.css">

    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
    <script src="../javascripts/bootstrap-select-1.13.2/bootstrap-select.js"></script>
    <script src="../javascripts/template7/template7.js"></script>

    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        .bootstrap-select > .dropdown-toggle .filter-option {
            padding-right: 20px;
        }

        .bootstrap-select > .dropdown-toggle.bs-placeholder.btn-outline-primary {
            color: #007bff;
        }

        .bootstrap-select > .dropdown-toggle.bs-placeholder.btn-outline-primary[aria-expanded="true"],
        .bootstrap-select > .dropdown-toggle.bs-placeholder.btn-outline-primary:hover,
        .bootstrap-select > .dropdown-toggle.bs-placeholder.btn-outline-primary:focus,
        .bootstrap-select > .dropdown-toggle.bs-placeholder.btn-outline-primary:active {
            color: #fff;
        }

        .dropdown-toggle::after {
            display: none !important;
        }

        .header-row {
            padding-top: 15px;
        }

        .problem-card {
            margin-top: 15px;
        }

        @media (max-width: 575.98px) {
            .bootstrap-select > .dropdown-toggle .filter-option {
                display: none !important;
            }

            .bootstrap-select {
                width: auto !important;
            }
        }

        .problem-answers {
            margin-bottom: 5px;
        }

        .problem-answers p {
            margin-bottom: 0;
        }

        .card-body .badges h5 {
            display: inline;
        }
    </style>
</head>
<body class="container">
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">115.бел</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="#">Обращения <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Статистика</a>
            </li>
        </ul>
    </div>
</nav>

<div class="row header-row justify-content-md-center">
    <div class="col-lg-8">
        <select class="selectpicker filter-status-btn" multiple data-max-options="3" data-style="btn-outline-primary"
                data-none-selected-text="Статус" data-select-all-text="Статус" data-icon="fa fa-filter">
            <option value="resolved" selected>Решено</option>
            <option value="under_control">На контроле</option>
            <option value="in_work">В работе</option>
        </select>

        <select class="selectpicker sort-date-btn" data-max-options="3" data-style="btn-outline-secondary"
                data-none-selected-text="Статус" data-select-all-text="Дата" data-icon="fa fa-sort">
            <option value="creating_date">Дата Создание</option>
            <option value="status_changing" selected>Дата изменение статуса</option>
        </select>

        <button type="button" class="btn btn-outline-secondary sort-order-btn"><i class="fa fa-sort-amount-down"></i></button>
    </div>
</div>


<div class="row justify-content-md-center">
    <div class="col-lg-8 problem-container">

    </div>
</div>

<script id="problem-card-template" type="text/template7">
    {{each #problems}}
    <div class="card problem-card">
        <div class="card-body">
            <h5 class="card-title">{{category_id}}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{address}}</h6>
            <p class="card-text">{{description}}</p>
            <div class="badges">
            {{#js_if "this.status == '5'"}}<h5><span class="badge badge-success">Решено</span></h5>{{/js_if}}
            {{#js_if "this.status == '5'"}}<h5><span class="badge badge-success">{{date date_solve}}</span></h5>{{/js_if}}

            {{#js_if "this.status == '7'"}}<h5><span class="badge badge-primary">На контроле</span></h5>{{/js_if}}
            {{#js_if "this.status == '7'"}}<h5><span class="badge badge-primary">{{date date_under_control}}</span></h5>{{/js_if}}

            {{#js_if "this.status == '4'"}}<h5><span class="badge badge-light">В работе</span></h5>{{/js_if}}
            {{#js_if "this.status == '4'"}}<h5><span class="badge badge-light">{{date crm_create_at}}</span></h5>{{/js_if}}

            <h5><span class="badge badge-dark">{{days_in_work this}}д</span></h5>
            </div>

            {{#if answers.length}}<p class="card-text"><small class="text-muted">Ответы:</small></p>{{/if}}

            <ul class="list-unstyled">
                {{#answers}}
                <li class="media problem-answers">
                    <div class="media-body">
                        <h6 class="mt-0 mb-1">{{organization}}</h6>
                        <p>{{text}}</p>
                        <small class="text-muted">{{date_time publish_date}}</small>
                    </div>
                </li>
                {{/answers}}
            </ul>

            <a href="http://115.xn--90ais{{href}}" class="card-link" target="_blank">Открыть на 115.бел</a>
        </div>
    </div>
    {{/each}}
</script>
<script>
    Template7.registerHelper('date_time', function (ruby_datetime, options) {
        if (typeof ruby_datetime === 'function') ruby_datetime = condition.call(this);

        var date_array = ruby_datetime.substr(0, 10).split('-'),
            time = ruby_datetime.substr(11, 5);
        return date_array[2] + '.' + date_array[1] + '.' + date_array[0] + ' ' + time;
    });

    Template7.registerHelper('date', function (ruby_date, options) {
        if (typeof ruby_date === 'function') ruby_date = condition.call(this);

        var date_array = ruby_date.substr(0, 10).split('-');
        return date_array[2] + '.' + date_array[1] + '.' + date_array[0];
    });

    Template7.registerHelper('days_in_work', function (problem, options) {
        if (typeof problem === 'function') problem = condition.call(this);

        if(problem.status === '5') {
            return Math.floor((new Date(problem.date_solve) - new Date(problem.crm_create_at)) / (1000 * 3600 * 24));
        }

        return Math.floor((new Date() - new Date(problem.crm_create_at)) / (1000 * 3600 * 24));
    });

    var template = Template7.compile($('#problem-card-template').html()),
        filter_options = ['resolved', 'under_control', 'in_work'];

    function getFormData() {
        return {
            filter: $('.selectpicker.filter-status-btn').val().length === 0 ? filter_options : $('.selectpicker.filter-status-btn').val(),
            order_by: $('.selectpicker.sort-date-btn').val(),
            order_type: $('.sort-order-btn i').hasClass('fa-sort-amount-down') ? 'desc' : 'asc'
        };
    }

    function prepareData(data) {
        var prepared_data = [];

        data.problems.forEach(function (problem) {
            prepared_data.push($.extend({}, problem, {answers: data.answers[problem.id] || []}));
        });
        console.log(prepared_data);
        return prepared_data;
    }

    function update() {
        console.log(getFormData());
        $.ajax('http://localhost:3000/api/v1/problems', {
            data: getFormData(),
            success: function (data) {
                $('.problem-container').empty();
                prepareData(data).forEach(function (problem) {
                    $('.problem-container').append(template(problem));
                });
            }
        });
    }

    $(function () {
        $('.selectpicker').selectpicker();

        $('.sort-order-btn').click(function () {
            $(this).find('i').toggleClass('fa-sort-amount-down fa-sort-amount-up');
            update();
        });

        $('.selectpicker.filter-status-btn, .selectpicker.sort-date-btn').change(update);

        update();

    });
</script>
</body>
</html>